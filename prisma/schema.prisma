// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Products table - stores the main product information
model Product {
  id               String   @id @default(uuid())
  handle           String   @unique @db.VarChar(255)
  title            String   @db.VarChar(255)
  description      String?  @db.Text
  descriptionHtml  String?  @map("description_html") @db.Text
  availableForSale Boolean  @default(true) @map("available_for_sale")
  seoTitle         String?  @map("seo_title") @db.VarChar(255)
  seoDescription   String?  @map("seo_description") @db.Text
  tags             String[] @default([])
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at")

  variants           ProductVariant[]
  images             ProductImage[]
  options            ProductOption[]
  productCollections ProductCollection[]
  reviews            Review[]

  @@index([handle], name: "products_handle_idx")
  @@index([tags], name: "products_tags_idx")
  @@map("products")
}

// Product variants - stores size, color, and other variant options
model ProductVariant {
  id               String   @id @default(uuid())
  productId        String   @map("product_id")
  title            String   @db.VarChar(255)
  price            Decimal  @db.Decimal(10, 2)
  currencyCode     String   @default("NGN") @map("currency_code") @db.VarChar(3)
  availableForSale Boolean  @default(true) @map("available_for_sale")
  selectedOptions  Json     @default("[]") @map("selected_options")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at")

  product   Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartLines CartLine[]

  @@index([productId], name: "product_variants_product_id_idx")
  @@map("product_variants")
}

// Product options - stores available options like "Size", "Color"
model ProductOption {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  name      String   @db.VarChar(100)
  values    String[]
  createdAt DateTime @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_options")
}

// Product images
model ProductImage {
  id         String   @id @default(uuid())
  productId  String   @map("product_id")
  url        String   @db.Text
  altText    String?  @map("alt_text") @db.VarChar(255)
  width      Int?
  height     Int?
  position   Int      @default(0)
  isFeatured Boolean  @default(false) @map("is_featured")
  createdAt  DateTime @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId], name: "product_images_product_id_idx")
  @@index([position], name: "product_images_position_idx")
  @@map("product_images")
}

// Collections (categories)
model Collection {
  id             String   @id @default(uuid())
  handle         String   @unique @db.VarChar(255)
  title          String   @db.VarChar(255)
  description    String?  @db.Text
  seoTitle       String?  @map("seo_title") @db.VarChar(255)
  seoDescription String?  @map("seo_description") @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")

  productCollections ProductCollection[]

  @@index([handle], name: "collections_handle_idx")
  @@map("collections")
}

// Many-to-many relationship between products and collections
model ProductCollection {
  id           String   @id @default(uuid())
  productId    String   @map("product_id")
  collectionId String   @map("collection_id")
  position     Int      @default(0)
  createdAt    DateTime @default(now()) @map("created_at")

  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@index([productId], name: "product_collections_product_id_idx")
  @@index([collectionId], name: "product_collections_collection_id_idx")
  @@map("product_collections")
}

// Carts table
model Cart {
  id             String   @id @default(uuid())
  checkoutUrl    String?  @map("checkout_url") @db.Text
  totalQuantity  Int      @default(0) @map("total_quantity")
  subtotalAmount Decimal  @default(0.00) @map("subtotal_amount") @db.Decimal(10, 2)
  totalAmount    Decimal  @default(0.00) @map("total_amount") @db.Decimal(10, 2)
  totalTaxAmount Decimal  @default(0.00) @map("total_tax_amount") @db.Decimal(10, 2)
  currencyCode   String   @default("NGN") @map("currency_code") @db.VarChar(3)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")

  lines CartLine[]

  @@map("carts")
}

// Cart lines (items in cart)
model CartLine {
  id               String   @id @default(uuid())
  cartId           String   @map("cart_id")
  productVariantId String   @map("product_variant_id")
  quantity         Int      @default(1)
  totalAmount      Decimal  @default(0.00) @map("total_amount") @db.Decimal(10, 2)
  currencyCode     String   @default("NGN") @map("currency_code") @db.VarChar(3)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at")

  cart    Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant ProductVariant @relation(fields: [productVariantId], references: [id])

  @@index([cartId], name: "cart_lines_cart_id_idx")
  @@index([productVariantId], name: "cart_lines_variant_id_idx")
  @@map("cart_lines")
}

// Pages table for static content
model Page {
  id             String   @id @default(uuid())
  handle         String   @unique @db.VarChar(255)
  title          String   @db.VarChar(255)
  body           String?  @db.Text
  bodySummary    String?  @map("body_summary") @db.Text
  seoTitle       String?  @map("seo_title") @db.VarChar(255)
  seoDescription String?  @map("seo_description") @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")

  @@index([handle], name: "pages_handle_idx")
  @@map("pages")
}

// Menus for navigation
model Menu {
  id        String   @id @default(uuid())
  handle    String   @unique @db.VarChar(255)
  title     String   @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  items MenuItem[]

  @@map("menus")
}

// Menu items
model MenuItem {
  id        String   @id @default(uuid())
  menuId    String   @map("menu_id")
  title     String   @db.VarChar(255)
  url       String   @db.Text
  position  Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  menu Menu @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@index([menuId], name: "menu_items_menu_id_idx")
  @@index([position], name: "menu_items_position_idx")
  @@map("menu_items")
}

// Admin users for dashboard access
model AdminUser {
  id           String    @id @default(uuid())
  email        String    @unique @db.VarChar(255)
  name         String?   @db.VarChar(255)
  passwordHash String    @map("password_hash") @db.Text
  role         String    @default("admin") @db.VarChar(50)
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at")

  @@index([email], name: "admin_users_email_idx")
  @@map("admin_users")
}

// Customer users for shopping
model User {
  id              String    @id @default(uuid())
  email           String    @unique @db.VarChar(255)
  name            String?   @db.VarChar(255)
  passwordHash    String    @map("password_hash") @db.Text
  phone           String?   @db.VarChar(50)
  shippingAddress Json?     @map("shipping_address")
  billingAddress  Json?     @map("billing_address")
  isActive        Boolean   @default(true) @map("is_active")
  lastLoginAt     DateTime? @map("last_login_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at")

  orders         Order[]
  abandonedCarts AbandonedCart[]
  reviews        Review[]
  reviewVotes    ReviewVote[]

  @@index([email], name: "users_email_idx")
  @@map("users")
}

// Orders for tracking purchases
model Order {
  id                  String    @id @default(uuid())
  userId              String?   @map("user_id")
  orderNumber         String    @unique @db.VarChar(50)
  email               String    @db.VarChar(255)
  phone               String?   @db.VarChar(50)
  customerName        String    @map("customer_name") @db.VarChar(255)
  shippingAddress     Json      @map("shipping_address")
  billingAddress      Json?     @map("billing_address")
  status              String    @default("pending") @db.VarChar(50)
  // Delivery tracking fields
  deliveryStatus      String    @default("production") @map("delivery_status") @db.VarChar(50)
  estimatedArrival    DateTime? @map("estimated_arrival")
  // Financial fields
  subtotalAmount      Decimal   @map("subtotal_amount") @db.Decimal(10, 2)
  taxAmount           Decimal   @default(0.00) @map("tax_amount") @db.Decimal(10, 2)
  shippingAmount      Decimal   @default(0.00) @map("shipping_amount") @db.Decimal(10, 2)
  totalAmount         Decimal   @map("total_amount") @db.Decimal(10, 2)
  currencyCode        String    @default("NGN") @map("currency_code") @db.VarChar(3)
  notes               String?   @db.Text
  trackingNumber      String?   @map("tracking_number") @db.VarChar(100)
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at")

  user  User?       @relation(fields: [userId], references: [id])
  items OrderItem[]

  @@index([orderNumber], name: "orders_order_number_idx")
  @@index([userId], name: "orders_user_id_idx")
  @@index([email], name: "orders_email_idx")
  @@index([status], name: "orders_status_idx")
  @@index([deliveryStatus], name: "orders_delivery_status_idx")
  @@map("orders")
}

// Order items
model OrderItem {
  id               String   @id @default(uuid())
  orderId          String   @map("order_id")
  productId        String   @map("product_id")
  productVariantId String   @map("product_variant_id")
  productTitle     String   @map("product_title") @db.VarChar(255)
  variantTitle     String   @map("variant_title") @db.VarChar(255)
  quantity         Int
  price            Decimal  @db.Decimal(10, 2)
  totalAmount      Decimal  @map("total_amount") @db.Decimal(10, 2)
  currencyCode     String   @default("NGN") @map("currency_code") @db.VarChar(3)
  productImage     String?  @map("product_image") @db.Text
  createdAt        DateTime @default(now()) @map("created_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId], name: "order_items_order_id_idx")
  @@map("order_items")
}

// Newsletter subscribers
model NewsletterSubscriber {
  id             String    @id @default(uuid())
  email          String    @unique @db.VarChar(255)
  name           String?   @db.VarChar(255)
  status         String    @default("active") @db.VarChar(50) // active, unsubscribed
  subscribedAt   DateTime  @default(now()) @map("subscribed_at")
  unsubscribedAt DateTime? @map("unsubscribed_at")

  @@index([email], name: "newsletter_subscribers_email_idx")
  @@index([status], name: "newsletter_subscribers_status_idx")
  @@map("newsletter_subscribers")
}

// Abandoned cart tracking for logged-in users
model AbandonedCart {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  cartId          String    @map("cart_id")
  email           String    @db.VarChar(255)
  customerName    String    @map("customer_name") @db.VarChar(255)
  cartTotal       Decimal   @map("cart_total") @db.Decimal(10, 2)
  items           Json      // Store cart items as JSON
  emailSent       Boolean   @default(false) @map("email_sent")
  emailSentAt     DateTime? @map("email_sent_at")
  recovered       Boolean   @default(false)
  recoveredAt     DateTime? @map("recovered_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  expiresAt       DateTime  @map("expires_at") // When to consider it truly abandoned (e.g., 1 hour)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], name: "abandoned_carts_user_id_idx")
  @@index([emailSent], name: "abandoned_carts_email_sent_idx")
  @@index([expiresAt], name: "abandoned_carts_expires_at_idx")
  @@map("abandoned_carts")
}

// Product reviews
model Review {
  id           String   @id @default(uuid())
  productId    String   @map("product_id")
  userId       String?  @map("user_id")
  orderId      String?  @map("order_id") // Link to order for verified purchases
  rating       Int      // 1-5
  title        String?  @db.VarChar(255)
  comment      String?  @db.Text
  images       String[] @default([]) // Array of image URLs
  isVerified   Boolean  @default(false) @map("is_verified") // Verified purchase badge
  helpfulCount Int      @default(0) @map("helpful_count")
  status       String   @default("pending") @db.VarChar(50) // pending, approved, rejected
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  product Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User?        @relation(fields: [userId], references: [id])
  votes   ReviewVote[]

  @@index([productId], name: "reviews_product_id_idx")
  @@index([userId], name: "reviews_user_id_idx")
  @@index([status], name: "reviews_status_idx")
  @@index([rating], name: "reviews_rating_idx")
  @@map("reviews")
}

// Review helpful votes
model ReviewVote {
  id        String   @id @default(uuid())
  reviewId  String   @map("review_id")
  userId    String   @map("user_id")
  isHelpful Boolean  @map("is_helpful")
  createdAt DateTime @default(now()) @map("created_at")

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id])

  @@unique([reviewId, userId], name: "review_vote_unique")
  @@index([reviewId], name: "review_votes_review_id_idx")
  @@map("review_votes")
}

// Customer testimonials for homepage
model Testimonial {
  id           String   @id @default(uuid())
  customerName String   @map("customer_name") @db.VarChar(255)
  role         String?  @db.VarChar(255) // e.g., "Fashion Enthusiast", "Regular Customer"
  content      String   @db.Text
  rating       Int      // 1-5
  image        String?  @db.Text // Customer photo URL
  isActive     Boolean  @default(true) @map("is_active")
  position     Int      @default(0) // For ordering
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  @@index([isActive], name: "testimonials_is_active_idx")
  @@index([position], name: "testimonials_position_idx")
  @@map("testimonials")
}

// Size guides for different product types
model SizeGuide {
  id           String   @id @default(uuid())
  productType  String   @db.VarChar(100) // e.g., "shoes", "sandals", "boots"
  title        String   @db.VarChar(255)
  sizesChart   Json     // Size conversion data (US, UK, EU, CM)
  measurements Json     // Measurement instructions
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  @@index([productType], name: "size_guides_product_type_idx")
  @@map("size_guides")
}

// Discount coupons for marketing campaigns
model Coupon {
  id             String    @id @default(uuid())
  code           String    @unique @db.VarChar(50)
  description    String?   @db.Text
  discountType   String    @map("discount_type") @db.VarChar(20) // "percentage", "fixed", "free_shipping"
  discountValue  Decimal   @map("discount_value") @db.Decimal(10, 2) // Percentage or fixed amount
  minOrderValue  Decimal?  @map("min_order_value") @db.Decimal(10, 2) // Minimum cart value required
  maxUses        Int?      @map("max_uses") // Max total uses (null = unlimited)
  usedCount      Int       @default(0) @map("used_count")
  maxUsesPerUser Int?      @map("max_uses_per_user") // Max uses per customer (null = unlimited)
  isActive       Boolean   @default(true) @map("is_active")
  startDate      DateTime? @map("start_date")
  expiryDate     DateTime? @map("expiry_date")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at")

  @@index([code], name: "coupons_code_idx")
  @@index([isActive], name: "coupons_is_active_idx")
  @@map("coupons")
}


